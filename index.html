<html>
<head>
    <style type="text/css">
        canvas {
            width: 700px;
            height: 600px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
        }
    </style>
</head>
<body>
<!--

init a canvas
find the first room from settings
find the tiles for the first room



-->
<script src="../ga/ga.js"></script>
<script src="../ga/plugins.js"></script>
<script type="module">
    console.log("loading stuff")
    let DATA = null
    let CANVAS = null
    const TILE_WIDTH = 16
    const tile_width = 16
    const tile_height = 16
    const TILE_HEIGHT = 16
    const _scale = 4
    const IMAGES = {}
    const log = (...args) => console.log(...args)
    let STATE = {
        roomid:""
    }

    let ctx = null

    async function load_room(STATE, id) {
        STATE.room = DATA.maps[id]
        log("state is",STATE)
        let data = await fetch(`./maps/${STATE.room.path}`).then(res => res.json())
        STATE.ROOM = new Room(data)
        log("ROOM is",STATE.ROOM)
        log("player will be positioned at", STATE.ROOM.start)
    }


        class Room {
            constructor(data) {
                this.data = data
            }
            draw(ctx) {
                this.draw_room(ctx, this.data)
            }
            drawLayer(ctx, layer) {
                if (layer.type !== 'drawn') return
                if (layer.visible == false) return
                // log("drawing",layer)
                layer.data.forEach((info, n) => {
                    if (!info) return
                    let x = n % layer.width
                    let y = Math.floor(n / layer.width)
                    let group = info.master.group
                    let id = info.master.id
                    let tg = DATA.tilegroups[group]
                    let tile = tg.tiles[id]
                    let imageid = tile.image
                    draw_tile(ctx, { x, y }, {x:0, y:0}, tile.center, imageid)
                })
            }
            draw_room(ctx, room) {
                //console.log("drawing room", room)
                ctx.fillStyle = room.background
                ctx.fillRect(0, 0, room.width * tile_width * _scale, room.height * tile_height * _scale)
                room.layers.forEach(layer => this.drawLayer(ctx, layer))
            }
        }

        class Player {
            constructor(info) {
                this.info = info
                log("player info is", this.info)
                log("player image is", IMAGES[this.info.image])
                this.center = {
                    x: 4,
                    y: 5,
                }
                this.offset = {
                    x:0,
                    y:0,
                }
            }
            draw(ctx) {
                draw_tile(ctx, this.center, this.offset, this.info.center, this.info.image)
            }
        }

    async function clearCanvas(ctx) {
        ctx.fillStyle = 'red'
        ctx.fillRect(0,0,CANVAS.width, CANVAS.height)
    }

    async function load_images() {
        // log("loading images",DATA.images)
        for(let key of Object.keys(DATA.images)) {
            // log("key is",key)
            IMAGES[key] = await load_image(DATA.images[key])
        }
    }
    function load_image(path) {
        return new Promise((res,rej)=>{
            let img = new Image()
            // log("starting to load",path)
            img.addEventListener('load',()=>{
                // log("finished loading",path,img)
                res(img)
            })
            img.src = path
        })
    }
    async function make_canvas() {
        CANVAS = document.createElement('canvas')
        CANVAS.width = 700
        CANVAS.height = 600
        document.body.appendChild(CANVAS)
        ctx = CANVAS.getContext('2d')
        ctx.imageSmoothingEnabled = false
    }
    async function setup_player() {
        STATE.playerid = "user"
        STATE.playerinfo = DATA.people.find(p => p.id === STATE.playerid)
        STATE.PLAYER = new Player(STATE.playerinfo)
    }
    function player_enter_room(player,room) {
        log("player goes to room",player,room.data.start)
        player.x = room.data.start.x
        player.y = room.data.start.y
    }

    function draw_tile(ctx, position,  offset, tile_center, imageid) {
        //log('drawing a tile at ',center, 'from tile',info,'from image',imageid)
        let image = IMAGES[imageid]
        let sx = tile_center.x * tile_width
        let sy = tile_center.y * tile_height
        let sw = tile_width
        let sh = tile_height
        let dx = (position.x * tile_width + offset.x) * _scale 
        let dy = (position.y * tile_height + offset.y) * _scale
        let dw = tile_width * _scale
        let dh = tile_height * _scale
        ctx.drawImage(image, sx,sy,sw,sh, dx,dy,dw,dh)
    }


    class Keyboard {
        constructor() {
            this.keyboard = {}
        }
        setup_input() {
            document.addEventListener('keydown', (e) => {
                this.keyboard[e.key] = true
            })
            document.addEventListener('keyup', (e) => {
                this.keyboard[e.key] = false
            })
        }
        is_pressed(name) {
            if(this.keyboard.hasOwnProperty(name) && this.keyboard[name] == true) {
                return true;
            } else {
                return false;
            }
        }
    }
    const keyboard = new Keyboard()

    function print(...args) {
        log(...args)
    }
    function check_input() {
        if(keyboard.is_pressed('ArrowUp')) STATE.PLAYER.offset.y -= 1
        if(keyboard.is_pressed('ArrowDown')) STATE.PLAYER.offset.y += 1
        if(keyboard.is_pressed('ArrowLeft')) STATE.PLAYER.offset.x -= 1
        if(keyboard.is_pressed('ArrowRight')) STATE.PLAYER.offset.x += 1
    }
    function game_loop() {
        requestAnimationFrame(game_loop)
        check_input()
        STATE.ROOM.draw(ctx)
        STATE.PLAYER.draw(ctx)
    }
    function start_game_loop() {
        requestAnimationFrame(game_loop)
    }
    async function setup() {
        await make_canvas()
        DATA = await fetch("./config.json").then(res => res.json())
        console.log("got the data",DATA)
        log("settings",DATA.settings)
        STATE.roomid = DATA.settings.startMapId
        //STATE.roomid = 'bedroom'
        await load_images()
        await load_room(STATE, STATE.roomid)
        clearCanvas(ctx)
        await setup_player()
        player_enter_room(STATE.PLAYER, STATE.ROOM)

        await keyboard.setup_input()
        start_game_loop()
    }
    setup().then(()=>{
        console.log("done")
    })
</script>
</body>
</html>

<html>

<head>
    <style type="text/css">
        canvas {
            width: 700px;
            height: 600px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <script type="module">
        import { Keyboard } from "./js/keyboard.js"
        import { Room } from "./js/room.js"
        import { Player } from "./js/player.js"
        import { Point, make_point, clone_point} from "./js/util.js"
        import { AssetManager} from "./js/assets.js"
        import { Surface, DebugOverlay} from "./js/drawing.js"
        import { ActionManager } from "./js/actions.js"
        import {GameState} from "./js/game.js"

        let DATA = null
        const log = (...args) => console.log(...args)
        let STATE = new GameState()
        let layers = []
        let room_layer = []
        let assets
        let surface = null
        let keyboard = null
        let actions = null


        function print(...args) {
            log(...args)
        }
        function is_item_visible(info) {
            if(info.settings.visible) return info.settings.visible.value
            return true
        }
        function attempt_move(player,offset) {
            STATE.test_tile = player.center.add(offset)
            let infos = STATE.ROOM.tile_info_at_pixel(surface, STATE.test_tile)
            for (let info of infos) {
                if (info.type === 'tile' && info.blocking) return
                if (info.type === 'item') {
                    if(is_item_visible(info)) {
                        log("blocked by an item",info)
                        STATE.dispatch_event({type:'use-item',info:info, room:STATE.ROOM})
                        return
                    }
                }
            }
            player.offset_by(offset)
            player.normalize()
            STATE.move_scroll(offset)
        }
        function check_input() {
            let player = STATE.PLAYER
            if (keyboard.is_pressed('ArrowUp'))    attempt_move(player,make_point(0,-1))
            if (keyboard.is_pressed('ArrowDown'))  attempt_move(player,make_point(0,+1))
            if (keyboard.is_pressed('ArrowLeft'))  attempt_move(player, make_point(-1,0))
            if (keyboard.is_pressed('ArrowRight')) attempt_move(player,make_point(+1,0))
        }


        function game_loop() {
            check_input()
            actions.check_events()
            surface.clear()
            layers.forEach(layer => {
                if(Array.isArray(layer)) {
                    layer.forEach(layer2 => {
                        layer2.draw(surface)
                    })
                } else {
                    layer.draw(surface)
                }
            })
            requestAnimationFrame(game_loop)
        }
        function start_game_loop() {
            requestAnimationFrame(game_loop)
        }
        async function setup() {
            DATA = await fetch("./config.json").then(res => res.json())
            let roomid = DATA.settings.startMapId
            assets = new AssetManager(DATA,STATE)
            await assets.load_images()
            STATE.ROOM = await assets.load_room(roomid)

            surface = new Surface(STATE,assets,DATA)
            let playerinfo = DATA.people.find(p => p.id === "user")
            STATE.PLAYER = new Player(playerinfo)
            keyboard = new Keyboard()
            await keyboard.setup_input()
            room_layer.push(STATE.ROOM)
            layers.push(room_layer)
            layers.push(STATE.PLAYER)
            layers.push(new DebugOverlay(STATE))

            actions = new ActionManager(STATE,keyboard,room_layer,assets, surface)
            actions.player_enter_room(STATE.PLAYER, STATE.ROOM)
            start_game_loop()
        }
        setup().then(() => {
            console.log("done")
        })
    </script>
</body>

</html>

<html>
<head>
    <style type="text/css">
        canvas {
            width: 700px;
            height: 600px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
        }
    </style>
</head>
<body>
<!--

init a canvas
find the first room from settings
find the tiles for the first room



-->
<script src="../ga/ga.js"></script>
<script src="../ga/plugins.js"></script>
<script type="module">
    console.log("loading stuff")
    let DATA = null
    let CANVAS = null
    const TILE_WIDTH = 16
    const tile_width = 16
    const tile_height = 16
    const TILE_HEIGHT = 16
    const _scale = 4
    const IMAGES = {}
    const log = (...args) => console.log(...args)
    let STATE = {
        roomid:""
    }

    let ctx = null

    async function load_room(STATE, id) {
        STATE.room = DATA.maps[id]
        log("state is",STATE)
        STATE.ROOM = await fetch(`./maps/${STATE.room.path}`).then(res => res.json())
        log("ROOM is",STATE.ROOM)
        log("player will be positioned at", STATE.ROOM.start)

    }

    function draw_room(room) {
        console.log("drawing room",room)
        ctx.fillStyle = room.background
        ctx.fillRect(0,0,room.width * tile_width * _scale, room.height * tile_height * _scale)
        room.layers.forEach(layer => drawLayer(layer))
    }

    function drawLayer(layer) {
        if(layer.type !== 'drawn') return
        if(layer.visible == false) return
        // log("drawing",layer)
        layer.data.forEach((info, n) => {
            if(!info) return
            let x = n % layer.width
            let y = Math.floor(n / layer.width)
            let group = info.master.group
            let id = info.master.id
            let tg = DATA.tilegroups[group]
            let tile = tg.tiles[id]
            let imageid = tile.image
            draw_tile(ctx, {x,y}, tile.center, imageid)
        })
    }

    async function clearCanvas(ctx) {
        ctx.fillStyle = 'red'
        ctx.fillRect(0,0,CANVAS.width, CANVAS.height)
    }

    async function load_images() {
        // log("loading images",DATA.images)
        for(let key of Object.keys(DATA.images)) {
            // log("key is",key)
            IMAGES[key] = await load_image(DATA.images[key])
        }
    }
    function load_image(path) {
        return new Promise((res,rej)=>{
            let img = new Image()
            // log("starting to load",path)
            img.addEventListener('load',()=>{
                // log("finished loading",path,img)
                res(img)
            })
            img.src = path
        })
    }
    async function make_canvas() {
        CANVAS = document.createElement('canvas')
        CANVAS.width = 700
        CANVAS.height = 600
        document.body.appendChild(CANVAS)
        ctx = CANVAS.getContext('2d')
        ctx.imageSmoothingEnabled = false
    }
    async function setup_player() {
        STATE.playerid = "user"
        STATE.playerinfo = DATA.people.find(p => p.id === STATE.playerid)
        log("player info is",STATE.playerinfo)
        log("player image is",IMAGES[STATE.playerinfo.image])
        STATE.PLAYER = {
            x:4,
            y:5,
        }
    }
    function player_enter_room(player,room) {
        log("player goes to room",player,room)
        player.x = room.start.x
        player.y = room.start.y
    }
    function draw_tile(ctx, position, tile_center, imageid) {
        //log('drawing a tile at ',center, 'from tile',info,'from image',imageid)
        let image = IMAGES[imageid]
        let sx = tile_center.x * tile_width
        let sy = tile_center.y * tile_height
        let sw = tile_width
        let sh = tile_height
        let dx = position.x * tile_width * _scale
        let dy = position.y * tile_height * _scale
        let dw = tile_width * _scale
        let dh = tile_height * _scale
        ctx.drawImage(image, sx,sy,sw,sh, dx,dy,dw,dh)
    }

    function draw_player(player) {
        // log("drawing player",player)
        ctx.fillStyle = 'green'
        ctx.fillRect(
            player.x * tile_width * _scale, 
            player.y * tile_height * _scale, 
            tile_width * _scale, 
            tile_height * _scale)
        let image = IMAGES[STATE.playerinfo.image]
        // log("player image is",image)
        draw_tile(ctx, player, STATE.playerinfo.center, STATE.playerinfo.image)
    }

    async function setup() {
        await make_canvas()
        DATA = await fetch("./config.json").then(res => res.json())
        console.log("got the data",DATA)
        log("settings",DATA.settings)
        STATE.roomid = DATA.settings.startMapId
        //STATE.roomid = 'bedroom'
        await load_images()
        await load_room(STATE, STATE.roomid)
        clearCanvas(ctx)

        await setup_player()
        draw_room(STATE.ROOM)
        player_enter_room(STATE.PLAYER, STATE.ROOM)
        draw_player(STATE.PLAYER)
    }
    setup().then(()=>{
        console.log("done")
    })
</script>
</body>
</html>

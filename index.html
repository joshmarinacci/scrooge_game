<html>

<head>
    <style type="text/css">
        canvas {
            width: 700px;
            height: 600px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <!--

- init a canvas
- find the first room from settings
- find the tiles for the first room
- draw the player
when move
    lookup tiles under player position
    if collide, don't allow the movement
    else update the scroll

    if colliding with an item emit an item event
    if colliding with a tile emit a collision event

    look up actions for that item using item.settings.id

check actions
    if dialog action, kick off a dialog process and pause the input to the render loop
    if it's a script event, eval script
    add next action if any to the event queue
-->
    <script src="../ga/ga.js"></script>
    <script src="../ga/plugins.js"></script>
    <script type="module">
        import { Keyboard } from "./js/keyboard.js"
        import { Room } from "./js/room.js"
        import { Player } from "./js/player.js"
        import { Point, make_point, clone_point} from "./js/util.js"
        import { AssetManager} from "./js/assets.js"
        import { Surface, DebugOverlay} from "./js/drawing.js"

        let DATA = null
        const log = (...args) => console.log(...args)
        let STATE = {
            roomid: "",
            scroll: {
                x: 0,
                y: -16 * 3,
            },
            events:[],
            test_tile : new Point(0,0)
        }
        let layers = []
        let assets
        let surface = null
        let keyboard = null

        function player_enter_room(player, room) {
            log("player goes to room", player, room.data.start)
            player.x = room.data.start.x
            player.y = room.data.start.y
        }


        function print(...args) {
            log(...args)
        }
        function attempt_move(player,offset) {
            STATE.test_tile = clone_point(player.center).add(offset)
            let infos = STATE.ROOM.tile_info_at_pixel(surface, STATE.test_tile)
            for (let info of infos) {
                    if (info.type === 'tile' && info.blocking) return
                    if (info.type === 'item') {
                        log("blocked by an item")
                        STATE.events.push({type:'use-item',info:info, room:STATE.ROOM})
                        return
                    }
                }
            player.offset.y += offset.y
            player.offset.x += offset.x
            player.normalize()
            STATE.scroll.y -= offset.y
            STATE.scroll.x -= offset.x
        }
        function check_input() {
            let player = STATE.PLAYER
            if (keyboard.is_pressed('ArrowUp'))    attempt_move(player,make_point(0,-1))
            if (keyboard.is_pressed('ArrowDown'))  attempt_move(player,make_point(0,+1))
            if (keyboard.is_pressed('ArrowLeft'))  attempt_move(player, make_point(-1,0))
            if (keyboard.is_pressed('ArrowRight')) attempt_move(player,make_point(+1,0))
        }
        function check_events() {
            STATE.events.forEach(evt => {
                log("event happened",evt)
                if(evt.type === 'use-item') {
                    log("doing action", evt.info)
                    log("room is",evt.room)
                    let action = evt.room.data.actions.find(act => act.itemid == evt.info.settings.id.value)
                    log("actions are",action)
                }
            })
            STATE.events = []
        }


        function game_loop() {
            check_input()
            check_events()
            surface.clear()
            layers.forEach(layer => layer.draw(surface))
            requestAnimationFrame(game_loop)
        }
        function start_game_loop() {
            requestAnimationFrame(game_loop)
        }
        async function setup() {
            DATA = await fetch("./config.json").then(res => res.json())
            STATE.roomid = DATA.settings.startMapId
            assets = new AssetManager(DATA,STATE)
            await assets.load_images()
            STATE.ROOM = await assets.load_room(STATE.roomid)
            surface = new Surface(STATE,assets,DATA)
            let playerinfo = DATA.people.find(p => p.id === "user")
            STATE.PLAYER = new Player(playerinfo)
            keyboard = new Keyboard()
            await keyboard.setup_input()
            layers.push(STATE.ROOM)
            layers.push(STATE.PLAYER)
            layers.push(new DebugOverlay(STATE))

            player_enter_room(STATE.PLAYER, STATE.ROOM)
            start_game_loop()
        }
        setup().then(() => {
            console.log("done")
        })
    </script>
</body>

</html>
<html>

<head>
    <style type="text/css">
        canvas {
            width: 700px;
            height: 600px;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <!--

- init a canvas
- find the first room from settings
- find the tiles for the first room
- draw the player
when move
    lookup tiles under player position
    if collide, don't allow the movement
    else update the scroll

    if colliding with an item emit an item event
    if colliding with a tile emit a collision event

    look up actions for that item using item.settings.id

check actions
    if dialog action, kick off a dialog process and pause the input to the render loop
    if it's a script event, eval script
    add next action if any to the event queue
-->
    <script src="../ga/ga.js"></script>
    <script src="../ga/plugins.js"></script>
    <script type="module">
        import { Keyboard } from "./js/keyboard.js"
        import { Room } from "./js/room.js"
        import { Player } from "./js/player.js"
        import { Point, make_point, clone_point} from "./js/util.js"
        import { AssetManager} from "./js/assets.js"
        import { Surface, DebugOverlay} from "./js/drawing.js"
        import { ActionManager } from "./js/actions.js"

        let DATA = null
        const log = (...args) => console.log(...args)
        let STATE = {
            scroll: make_point(0,0),
            events:[],
            test_tile : new Point(0,0)
        }
        let layers = []
        let room_layer = []
        let assets
        let surface = null
        let keyboard = null
        let actions = null


        function print(...args) {
            log(...args)
        }
        function is_item_visible(info) {
            if(info.settings.visible) return info.settings.visible.value
            return true
        }
        function attempt_move(player,offset) {
            STATE.test_tile = clone_point(player.center).add(offset)
            let infos = STATE.ROOM.tile_info_at_pixel(surface, STATE.test_tile)
            for (let info of infos) {
                if (info.type === 'tile' && info.blocking) return
                if (info.type === 'item') {
                    if(is_item_visible(info)) {
                        log("blocked by an item",info)
                        STATE.events.push({type:'use-item',info:info, room:STATE.ROOM})
                        return
                    }
                }
            }
            player.offset.y += offset.y
            player.offset.x += offset.x
            player.normalize()
            STATE.scroll.y -= offset.y
            STATE.scroll.x -= offset.x
        }
        function check_input() {
            let player = STATE.PLAYER
            if (keyboard.is_pressed('ArrowUp'))    attempt_move(player,make_point(0,-1))
            if (keyboard.is_pressed('ArrowDown'))  attempt_move(player,make_point(0,+1))
            if (keyboard.is_pressed('ArrowLeft'))  attempt_move(player, make_point(-1,0))
            if (keyboard.is_pressed('ArrowRight')) attempt_move(player,make_point(+1,0))
        }


        function game_loop() {
            check_input()
            actions.check_events()
            surface.clear()
            layers.forEach(layer => {
                if(Array.isArray(layer)) {
                    layer.forEach(layer2 => {
                        layer2.draw(surface)
                    })
                } else {
                    layer.draw(surface)
                }
            })
            requestAnimationFrame(game_loop)
        }
        function start_game_loop() {
            requestAnimationFrame(game_loop)
        }
        async function setup() {
            DATA = await fetch("./config.json").then(res => res.json())
            let roomid = DATA.settings.startMapId
            assets = new AssetManager(DATA,STATE)
            await assets.load_images()
            STATE.ROOM = await assets.load_room(roomid)

            surface = new Surface(STATE,assets,DATA)
            let playerinfo = DATA.people.find(p => p.id === "user")
            STATE.PLAYER = new Player(playerinfo)
            keyboard = new Keyboard()
            await keyboard.setup_input()
            room_layer.push(STATE.ROOM)
            layers.push(room_layer)
            layers.push(STATE.PLAYER)
            layers.push(new DebugOverlay(STATE))

            actions = new ActionManager(STATE,keyboard,room_layer,assets, surface)
            actions.player_enter_room(STATE.PLAYER, STATE.ROOM)
            start_game_loop()
        }
        setup().then(() => {
            console.log("done")
        })
    </script>
</body>

</html>